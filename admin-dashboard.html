<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .star {
      background-color: white;
      border-radius: 50%;
      position: absolute;
      animation: twinkling 2s infinite, move 10s infinite;
    }
    @keyframes twinkling {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }
    @keyframes move {
      0% { transform: translate(0, 0); }
      100% { transform: translate(30px, 30px); }
    }
  </style>
</head>
<body class="bg-black text-white min-h-screen px-6 py-4 relative">
  <div id="starfield" class="absolute inset-0 z-0 pointer-events-none overflow-hidden"></div>
  <div class="absolute inset-0 bg-gradient-to-br from-transparent to-[#1a1a1a] z-0"></div>

  <h1 class="text-4xl font-bold text-center my-8 bg-gradient-to-r from-yellow-400 to-pink-500 text-transparent bg-clip-text">Admin Dashboard</h1>

  <section class="grid md:grid-cols-3 gap-6 z-10 relative" id="analytics"></section>

  <div class="mt-10 z-10 relative">
    <h2 class="text-2xl font-bold mb-4">Top 20 Referrers</h2>
    <table class="w-full text-left border-collapse">
      <thead>
        <tr class="bg-white/10">
          <th class="p-3">Referral Code</th>
          <th class="p-3">Referrals</th>
        </tr>
      </thead>
      <tbody id="topReferrers"></tbody>
    </table>

    <details class="mt-6">
      <summary class="cursor-pointer bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-md">View All Signups</summary>
      <div class="mt-4">
        <div class="flex flex-wrap gap-4 mb-4">
          <input type="date" id="filterDate" class="bg-white/5 p-2 rounded" placeholder="Signup Date">
          <input type="text" id="filterCode" class="bg-white/5 p-2 rounded" placeholder="Referral Code">
          <input type="number" id="filterCoins" class="bg-white/5 p-2 rounded" placeholder="Min Rave Coins">
          <button onclick="loadAllSignups()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">Apply Filters</button>
          <button onclick="exportToCSV()" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded">Export CSV</button>
        </div>
        <div id="allSignups" class="overflow-x-auto">
          <table class="min-w-full">
            <thead><tr><th>Name</th><th>Email</th><th>Signup Date</th></tr></thead>
            <tbody id="signupsList"></tbody>
          </table>
        </div>
      </div>
    </details>
  </div>

  <div class="mt-10 z-10 relative">
    <h2 class="text-2xl font-bold mb-4">User Signups Trend</h2>
    <canvas id="signupChart" class="bg-white/5 p-4 rounded-lg"></canvas>
  </div>

  <div class="mt-10 z-10 relative">
    <h2 class="text-2xl font-bold mb-4">Ad Engagement</h2>
    <canvas id="adChart" class="bg-white/5 p-4 rounded-lg"></canvas>
  </div>

  <div class="mt-10 z-10 relative">
    <h2 class="text-2xl font-bold mb-4">Region Stats</h2>
    <canvas id="regionChart" class="bg-white/5 p-4 rounded-lg"></canvas>
  </div>

  <div class="mt-10 z-10 relative">
    <h2 class="text-2xl font-bold mb-4">Device Usage</h2>
    <canvas id="deviceChart" class="bg-white/5 p-4 rounded-lg"></canvas>
  </div>

  <div class="mt-10 z-10 relative">
    <h2 class="text-2xl font-bold mb-4">System Logs</h2>
    <div id="logList" class="bg-white/5 border border-white/10 rounded-lg p-4 max-h-96 overflow-y-auto text-sm space-y-2"></div>
  </div>

  <script>
    const container = document.getElementById('starfield');
    for (let i = 0; i < 100; i++) {
      const star = document.createElement('div');
      const size = Math.random() * 2 + 1;
      star.className = 'star';
      star.style.width = `${size}px`;
      star.style.height = `${size}px`;
      star.style.top = `${Math.random() * 100}%`;
      star.style.left = `${Math.random() * 100}%`;
      star.style.animationDuration = `${1.5 + Math.random() * 2}s, ${15 + Math.random() * 10}s`;
      container.appendChild(star);
    }

    const token = localStorage.getItem('admin_token');
    if (!token) window.location.href = 'admin-login.html';

    fetch('https://pure-sea-47438-9b41a08c5720.herokuapp.com/admin/dashboard', {
      headers: { 'Authorization': 'Bearer ' + token }
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById('analytics').innerHTML = `
        <div class="bg-white/5 border border-white/10 rounded-xl p-6">
          <h2 class="text-xl font-semibold mb-2">Total Users</h2>
          <p class="text-3xl text-yellow-400 font-bold">${data.total_users}</p>
        </div>
        <div class="bg-white/5 border border-white/10 rounded-xl p-6">
          <h2 class="text-xl font-semibold mb-2">Total Coins Issued</h2>
          <p class="text-3xl text-green-400 font-bold">${data.total_rave_coins}</p>
        </div>
        <div class="bg-white/5 border border-white/10 rounded-xl p-6">
          <h2 class="text-xl font-semibold mb-2">Top Referrer</h2>
          <p class="text-lg text-blue-400">${data.top_referrers[0]?.referred_by || 'N/A'}</p>
          <p class="text-sm text-gray-300">${data.top_referrers[0]?.count || 0} referrals</p>
        </div>`;

      const tbody = document.getElementById('topReferrers');
      data.top_referrers.forEach(ref => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-3">${ref.referred_by}</td><td class="p-3">${ref.count}</td>`;
        tbody.appendChild(tr);
      });
    });

    function loadAllSignups() {
      const token = localStorage.getItem('admin_token');
      const date = document.getElementById('filterDate').value;
      const referralCode = document.getElementById('filterCode').value;
      const minCoins = document.getElementById('filterCoins').value;
      let query = '?';
      if (date) query += `signup_date=${date}&`;
      if (referralCode) query += `referral_code=${referralCode}&`;
      if (minCoins) query += `min_coins=${minCoins}&`;

      fetch(`https://pure-sea-47438-9b41a08c5720.herokuapp.com/admin/users${query}`, {
        headers: { 'Authorization': 'Bearer ' + token }
      })
      .then(res => res.json())
      .then(result => {
        if (!Array.isArray(result)) throw new Error('Expected array but got: ' + JSON.stringify(result));
        const container = document.getElementById('signupsList');
        container.innerHTML = '';
        result.forEach(user => {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${user.name}</td><td>${user.email}</td><td>${user.signup_date}</td>`;
          container.appendChild(row);
        });
      })
      .catch(err => {
        console.error('Failed to load all users:', err);
        alert('Could not load users. Please check the console.');
      });
    }

    function exportToCSV() {
      const table = document.querySelector('#allSignups table');
      if (!table) return alert('No data to export');
      const rows = Array.from(table.querySelectorAll('tr')).map(row =>
        Array.from(row.querySelectorAll('th, td')).map(cell => cell.innerText).join(',')
      );
      const csvContent = rows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'signups.csv';
      a.click();
    }
  </script>
</body>
</html>
